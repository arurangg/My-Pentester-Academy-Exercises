#!/usr/bin/env python
#scapy library does not work on localhost
import sys
import os
import threading
import Queue
from scapy.all import IP, TCP, sr1

class SynScannerThread(threading.Thread):

	def __init__(self, scansQueue,target):

		threading.Thread.__init__(self)
		self.scansQueue = scansQueue
		self.target = target

	def run(self):

		while True:
            		try:
				port = self.scansQueue.get()
			except Queue.empty:
				exit(0)
			ans = sr1( IP(dst=target)/TCP(dport=port, flags=2), verbose = False, timeout=.2)
			if(ans and ans[TCP].flags == 18):
				print "%d open"%port

			self.scansQueue.task_done()

if len(sys.argv) < 2:
	print sys.argv[0] + " <target>"
	sys.exit(1)

if os.geteuid() != 0:
	print "You don't have permission to run this script"
	sys.exit(1)

target = sys.argv[1]

scansQueue = Queue.Queue()
numScanners = 10
numPorts = 1000

for i in range(numScanners):
	synScanner = SynScannerThread(scansQueue,target)
	synScanner.setDaemon(True)
	synScanner.start()

for port in range(1,numPorts+1):
	scansQueue.put(port)

scansQueue.join()
